blueprint:
  name: Sync heater temperature with AC mode v1.4
  description: >
    Sets heater temperature based on AC mode.
    Heat -> 30°C, Cool -> 5°C.
    Works with multiple heaters.
    Runs only if at least one heater needs change.
    Supports extra actions per mode.
  domain: automation

  input:
    ac_entity:
      name: AC device
      selector:
        entity:
          domain: climate

    heater_entities:
      name: Heater devices
      selector:
        entity:
          domain: climate
          multiple: true

    heat_action:
      name: Extra action on HEAT
      default: []
      selector:
        action: {}

    cool_action:
      name: Extra action on COOL
      default: []
      selector:
        action: {}

trigger:
  - platform: state
    entity_id: []
    # This will be replaced by the AC entity when creating the automation from the blueprint

variables:
  ac: !input ac_entity
  heaters: !input heater_entities
  target_temp: >
    {% if is_state(ac, 'heat') %}
      30
    {% elif is_state(ac, 'cool') %}
      5
    {% else %}
      none
    {% endif %}

  heaters_to_update: >
    {% set result = [] %}
    {% for h in heaters %}
      {% set current = state_attr(h, 'temperature') | float(0) %}
      {% if target_temp != none and current != target_temp %}
        {% set result = result + [h] %}
      {% endif %}
    {% endfor %}
    {{ result }}

condition:
  - condition: template
    value_template: "{{ heaters_to_update | length > 0 }}"

action:
  - service: climate.set_temperature
    target:
      entity_id: "{{ heaters_to_update }}"
    data:
      temperature: "{{ target_temp }}"

  - choose:
      - conditions:
          - condition: state
            entity_id: !input ac_entity
            state: "heat"
        sequence: !input heat_action

      - conditions:
          - condition: state
            entity_id: !input ac_entity
            state: "cool"
        sequence: !input cool_action
